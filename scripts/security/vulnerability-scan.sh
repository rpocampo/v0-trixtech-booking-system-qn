#!/bin/bash

# TRIXTECH Booking System - Vulnerability Scanner
# This script performs comprehensive vulnerability scanning including:
# - NPM audit for dependency vulnerabilities
# - Trivy container image scanning
# - OWASP dependency check
# - Generates security reports and alerts

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
REPORTS_DIR="$PROJECT_ROOT/reports/security"
ENVIRONMENT="${ENVIRONMENT:-dev}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_FILE="$REPORTS_DIR/vulnerability_scan_$ENVIRONMENT_$TIMESTAMP.json"
ALERT_FILE="$REPORTS_DIR/security_alerts_$ENVIRONMENT_$TIMESTAMP.txt"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Create reports directory
mkdir -p "$REPORTS_DIR"

# Initialize report
REPORT_DATA='{
  "scan_timestamp": "'$(date -Iseconds)'",
  "environment": "'$ENVIRONMENT'",
  "scanner_version": "1.0.0",
  "vulnerabilities": {
    "npm_audit": {},
    "trivy": {},
    "owasp_dependency_check": {}
  },
  "summary": {
    "total_vulnerabilities": 0,
    "critical_count": 0,
    "high_count": 0,
    "medium_count": 0,
    "low_count": 0
  }
}'

# Function to update report
update_report() {
    local section=$1
    local data=$2
    REPORT_DATA=$(echo "$REPORT_DATA" | jq ".$section = $data")
}

# Function to send alert
send_alert() {
    local message=$1
    local severity=$2
    echo "[$(date)] $severity: $message" >> "$ALERT_FILE"

    # Send to notification service if configured
    if [ -n "$SLACK_WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
             --data "{\"text\":\"TRIXTECH Security Alert [$severity]: $message\"}" \
             "$SLACK_WEBHOOK_URL" || true
    fi

    if [ -n "$EMAIL_RECIPIENT" ]; then
        echo "$message" | mail -s "TRIXTECH Security Alert [$severity]" "$EMAIL_RECIPIENT" || true
    fi
}

# 1. NPM Audit Scan
log_info "Running NPM audit scan..."
cd "$PROJECT_ROOT/backend"
if [ -f "package.json" ]; then
    NPM_AUDIT_OUTPUT=$(npm audit --audit-level=moderate --json 2>/dev/null || echo '{"error": "NPM audit failed"}')
    update_report "vulnerabilities.npm_audit" "$NPM_AUDIT_OUTPUT"

    # Check for vulnerabilities
    VULN_COUNT=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.total // 0' 2>/dev/null || echo "0")
    CRITICAL_COUNT=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")

    if [ "$CRITICAL_COUNT" -gt 0 ]; then
        send_alert "Critical vulnerabilities found in backend dependencies: $CRITICAL_COUNT" "CRITICAL"
    fi

    log_info "NPM audit completed. Found $VULN_COUNT vulnerabilities."
else
    log_warn "Backend package.json not found, skipping NPM audit."
fi

cd "$PROJECT_ROOT/frontend"
if [ -f "package.json" ]; then
    NPM_AUDIT_FRONTEND=$(npm audit --audit-level=moderate --json 2>/dev/null || echo '{"error": "NPM audit failed"}')
    # Merge with backend results
    REPORT_DATA=$(echo "$REPORT_DATA" | jq ".vulnerabilities.npm_audit.frontend = $NPM_AUDIT_FRONTEND")
    log_info "Frontend NPM audit completed."
else
    log_warn "Frontend package.json not found, skipping NPM audit."
fi

# 2. Trivy Container Image Scan
log_info "Running Trivy container image scan..."
if command -v trivy &> /dev/null; then
    # Scan Docker images if they exist
    if [ -f "$PROJECT_ROOT/docker-compose.yml" ] || [ -f "$PROJECT_ROOT/docker-compose.prod.yml" ]; then
        TRIVY_OUTPUT=$(trivy image --format json --output - trixtech-booking-backend:latest 2>/dev/null || echo '{"error": "Trivy scan failed"}')
        update_report "vulnerabilities.trivy.backend" "$TRIVY_OUTPUT"

        TRIVY_FRONTEND=$(trivy image --format json --output - trixtech-booking-frontend:latest 2>/dev/null || echo '{"error": "Trivy scan failed"}')
        update_report "vulnerabilities.trivy.frontend" "$TRIVY_FRONTEND"

        # Check for critical vulnerabilities
        CRIT_VULNS=$(echo "$TRIVY_OUTPUT" | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' 2>/dev/null || echo "0")
        if [ "$CRIT_VULNS" -gt 0 ]; then
            send_alert "Critical vulnerabilities found in container images: $CRIT_VULNS" "CRITICAL"
        fi

        log_info "Trivy scan completed."
    else
        log_warn "No Docker compose files found, skipping Trivy scan."
    fi
else
    log_warn "Trivy not installed, skipping container image scan."
fi

# 3. OWASP Dependency Check
log_info "Running OWASP Dependency Check..."
if command -v dependency-check.sh &> /dev/null; then
    OWASP_REPORT_DIR="$REPORTS_DIR/owasp_$TIMESTAMP"
    mkdir -p "$OWASP_REPORT_DIR"

    # Run OWASP check on backend
    cd "$PROJECT_ROOT/backend"
    dependency-check.sh --project "TRIXTECH Backend" --scan . --format JSON --out "$OWASP_REPORT_DIR/backend.json" --nvdValidForHours 24 || true

    # Run OWASP check on frontend
    cd "$PROJECT_ROOT/frontend"
    dependency-check.sh --project "TRIXTECH Frontend" --scan . --format JSON --out "$OWASP_REPORT_DIR/frontend.json" --nvdValidForHours 24 || true

    # Read OWASP results
    if [ -f "$OWASP_REPORT_DIR/backend.json" ]; then
        OWASP_BACKEND=$(cat "$OWASP_REPORT_DIR/backend.json")
        update_report "vulnerabilities.owasp_dependency_check.backend" "$OWASP_BACKEND"
    fi

    if [ -f "$OWASP_REPORT_DIR/frontend.json" ]; then
        OWASP_FRONTEND=$(cat "$OWASP_REPORT_DIR/frontend.json")
        update_report "vulnerabilities.owasp_dependency_check.frontend" "$OWASP_FRONTEND"
    fi

    log_info "OWASP Dependency Check completed."
else
    log_warn "OWASP Dependency Check not installed, skipping."
fi

# Calculate summary
log_info "Calculating vulnerability summary..."
TOTAL_VULNS=$(echo "$REPORT_DATA" | jq '
  (.vulnerabilities.npm_audit.metadata.vulnerabilities.total // 0) +
  (.vulnerabilities.trivy.backend[].Results[]?.Vulnerabilities | length // 0) +
  (.vulnerabilities.trivy.frontend[].Results[]?.Vulnerabilities | length // 0) +
  (.vulnerabilities.owasp_dependency_check.backend.dependencies[]?.vulnerabilities | length // 0) +
  (.vulnerabilities.owasp_dependency_check.frontend.dependencies[]?.vulnerabilities | length // 0)
' 2>/dev/null || echo "0")

REPORT_DATA=$(echo "$REPORT_DATA" | jq ".summary.total_vulnerabilities = $TOTAL_VULNS")

# Generate final report
echo "$REPORT_DATA" > "$REPORT_FILE"

log_info "Vulnerability scan completed."
log_info "Report saved to: $REPORT_FILE"
if [ -f "$ALERT_FILE" ]; then
    log_info "Alerts saved to: $ALERT_FILE"
fi

# Exit with error code if critical vulnerabilities found
CRITICAL_TOTAL=$(echo "$REPORT_DATA" | jq '.summary.critical_count' 2>/dev/null || echo "0")
if [ "$CRITICAL_TOTAL" -gt 0 ]; then
    log_error "Critical vulnerabilities detected. Review the report and take action."
    exit 1
fi

log_info "No critical vulnerabilities found."